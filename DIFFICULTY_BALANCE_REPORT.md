# DOTHEGI 난이도/시간게이지 개선 리포트 (구현 전)

## 1) 목표
- 3x3 내부에서도 시간이 지날수록 자연스럽게 어려워지게 만들기
- 3x3 -> 4x4 전환 충격(체감 난이도 급상승) 최소화
- 남은 시간을 상단 게이지로 시각화해 긴장감/정보 전달 강화
- 상용 수준으로 밸런싱 가능한 구조(튜닝 포인트와 지표가 명확한 구조)로 재설계

## 2) 현재 구조 진단
- 현재는 `LEVEL_CONFIGS` 1단계가 3x3, 2단계가 4x4로 바로 점프함
  - `src/main.ts` `LEVEL_CONFIGS` (레벨 1 -> 2 전환 시 격자/동시출현/템포가 동시에 변함)
- 단계 내부 미세 난이도 곡선이 약함
  - 같은 레벨에서는 스폰/유지시간이 거의 고정 범위
- 체크포인트 PI는 있지만 전환은 계단식
  - `CHECKPOINT_MS = 5000`, `setLevel(+1/-1)` 방식
- 시간은 숫자만 표시되어 압박감/예측 정보가 약함

## 3) 게임이론/실전 밸런스 원칙
- Flow 채널 원칙: 플레이어 스킬 추정치와 난이도 목표치를 계속 맞춤
- 단계형 + 연속형 혼합 난이도:
  - 단계형: 그리드 확장(3x3 -> 4x4 ...)
  - 연속형: 각 단계 내부에서 파라미터를 선형/곡선 보간
- 전환 완충(Bridging):
  - 공간(그리드) 전환 전, 템포/동시출현/패널티를 먼저 부분적으로 올려 충격 완화
- 시각적 피드백 강화:
  - 시간 게이지 색 변화(녹색 -> 황색 -> 적색), 저시간 구간에서 펄스

## 4) 제안 난이도 시스템 (핵심)
### 4-1. 2축 난이도 모델
- `Grid Tier` (3~9): 공간 난이도 축
- `Tier Progress` (0~100): 해당 그리드 내부 미세 난이도 축

### 4-2. 전환 상태 머신
- `RUNNING`: 현재 그리드 진행
- `PROMOTION_PENDING`: 다음 그리드 예고/완충 (권장 6초)
- `PROMOTION_GRACE`: 승급 직후 보호구간 (권장 3초, 폭탄 약화)
- 다시 `RUNNING`

### 4-3. 스킬 추정치 (DDA)
- 체크포인트마다 현재 PI 계산(기존 유지)
- `skillEMA = (1-a)*skillEMA + a*PI`, 권장 `a=0.25`
- 승급 조건(예):
  - `tierProgress >= 85`
  - `skillEMA >= target + 0.08` 2회 연속
  - 최소 생존시간 조건 충족
- 강등 조건(예):
  - `skillEMA <= target - 0.18` 2회 연속

## 5) 3x3 -> 4x4 완충 설계 (정밀 파라미터)
### 5-1. 3x3 내부 3페이즈
| 구간 | 길이(권장) | spawn interval | hold time | 동시출현 | 폭탄 비중 |
|---|---:|---:|---:|---:|---:|
| 3x3-A (입문) | 0~30초 | 980 -> 900ms | 1250 -> 1100ms | 1 고정 | 2% -> 4% |
| 3x3-B (가속) | 30~60초 | 900 -> 830ms | 1100 -> 960ms | 1~2 (확률 0% -> 18%) | 4% -> 6% |
| 3x3-C (전환준비) | 60초+ | 830 -> 770ms | 960 -> 860ms | 1~2 (확률 18% -> 32%) | 6% -> 8% |

### 5-2. 승급 직전 완충 (`PROMOTION_PENDING`, 6초)
- 그리드는 3x3 유지
- 다음 그리드(4x4) 템포 파라미터를 0 -> 70% 보간 적용
- 상태 문구: `다음 난이도 준비중: 4x4`
- 배경/효과음/짧은 진동으로 전환 예고

### 5-3. 승급 직후 보호 (`PROMOTION_GRACE`, 3초)
- 그리드 4x4 적용
- 폭탄 비중 0% (3초 뒤 원복)
- hold time +12% 임시 완화
- 첫 인상 실패율 완화(체감 “갑자기 어렵다” 방지)

## 6) 시간 게이지 설계
### 6-1. UI
- 상단 HUD 아래에 가로 게이지 1줄 추가
- 좌측 텍스트: `TIME`
- 우측 텍스트: `남은 초`
- 채움바 색상:
  - 60% 이상: 녹색
  - 35~60%: 주황/노랑
  - 35% 미만: 빨강 + 약한 펄스

### 6-2. 수식
- `timeGaugeCapMs` 도입 (런 시작 30초)
- `timeRemainingMs`가 cap을 넘으면 cap 상향
- `fill = clamp(timeRemainingMs / timeGaugeCapMs, 0, 1)`
- 시간 보너스 시 게이지가 튀지 않고 자연스럽게 증가

## 7) 구현 계획 (파일 단위)
### 7-1. `src/main.ts`
- 난이도 상태 추가:
  - `gridTier`, `tierProgress`, `skillEMA`, `promotionState`, `promotionTimerMs`, `timeGaugeCapMs`
- `evaluateCheckpoint()` 재작성:
  - PI -> EMA 갱신 -> 진행도 증감 -> 승급/강등 판정
- `spawnSingleMole()/spawnMolesIfNeeded()`:
  - 현재 진행도 기준 보간 파라미터 사용
- `pickMoleType()`:
  - 진행도 기반 가중치 보간
- `syncHud()`:
  - 게이지 fill 값/색상 업데이트

### 7-2. `index.html`
- HUD 아래 시간 게이지 DOM 추가

### 7-3. `src/styles.css`
- 시간 게이지 스타일/저시간 펄스 애니메이션 추가
- 모바일 가로모드에서도 HUD와 충돌 없도록 media query 보정

## 8) 상용 품질 검증 기준 (수용 기준)
- 3x3 -> 4x4 전환 직후 10초간 `미스율 급증`이 기존 대비 20% 이상 감소
- 첫 60초 생존율 상승(너무 쉬워지지 않게 점수 분산은 유지)
- 시간 게이지가 모든 화면비에서 잘림/겹침 없음
- 모바일 터치 지연/FPS 저하 없음 (`npx tsc --noEmit`, `npm run build` 통과)

## 9) 리스크 및 대응
- 난이도 완화 과다: 상위 구간(7x7~9x9) 상한 파라미터 유지
- 전환 이벤트 과다 연출: 6초/3초로 짧게 제한
- 게이지가 복잡해 보일 수 있음: 숫자 시간은 기존처럼 유지하고 게이지만 보조로 사용

## 10) 구현 순서 제안
1. 시간 게이지 UI/동기화 먼저 적용
2. 난이도 상태 머신 + 3x3 내부 페이즈 적용
3. 3x3 -> 4x4 완충/보호 구간 적용
4. 전체 구간(5x5~9x9) 보간 파라미터 연결
5. 플레이 테스트 후 파라미터 1차 튜닝

