# 두더지 게임 상용형 프론트엔드 설계서 (v1.0)

## 1. 문서 목적
- 본 문서는 `프론트엔드만`으로 운영 가능한 두더지 게임의 상용형 설계를 정의한다.
- 핵심 목표는 다음 3가지다.
1. 모바일에서도 프레임 드랍 없는 안정적 플레이
2. 실력 기반 세션 연장(기본 30초 + 성과 보너스 시간)
3. 광고/보상 루프를 자연스럽게 연결하는 UX

## 2. 제품 방향
- 기본 모드는 `Adaptive 30+`로 고정한다.
1. 게임 시작 시 타이머 30초
2. 실력이 일정 기준을 넘으면 체크포인트마다 시간 연장
3. 실력이 낮으면 30초 내 종료
4. 난이도는 보드 크기를 `3x3 -> 9x9`로 점진 상승

## 3. 화면/흐름 설계
`타이틀 -> 플레이 -> 결과 -> 보상/광고 -> 재도전`

### 타이틀
- 시작 버튼
- 모드 설명(Adaptive 30+)
- 배너 광고 영역(상단 또는 하단)

### 플레이
- Canvas 1장: 보드, 두더지, 타격 이펙트 렌더링
- HTML 오버레이: 점수, 콤보, 남은 시간, 일시정지 버튼
- 광고는 플레이 방해 금지(배너만 허용)

### 결과
- 최종 점수, 최고 콤보, 정확도, 생존 시간 표시
- 실력 지표에 따른 등급(Bronze/Silver/Gold/Platinum)
- 인터스티셜 또는 보상형 광고 진입 버튼 배치

### 보상
- 광고 시청 시 코인 보너스, 1회 부활(옵션), 추가 스킨 조각 지급
- 이후 `다시 플레이`로 복귀

## 4. 게임 규칙 상세

### 4.1 세션 타이머 규칙
- `startTime = 30s`
- 5초마다 성과 평가 체크포인트 실행
- 체크포인트에서 기준 충족 시 시간 보너스 지급
- 최대 세션 시간 상한: `120s` (무한 연장 방지)

시간 보너스 규칙(체크포인트 기준):
1. 성과지수 PI >= 0.70: `+3s`
2. 성과지수 PI >= 0.85: `+5s`
3. 최근 5초 미스 0회 보너스: 추가 `+1s`
4. PI < 0.70: 연장 없음

결과:
- 초보자는 대부분 30초 전후 종료
- 숙련자는 40초, 60초, 90초 이상으로 자연 확장

### 4.2 난이도(보드 크기) 상승 규칙
- 난이도 레벨 `L`은 1~7
- 보드 크기 매핑:
1. L1: 3x3
2. L2: 4x4
3. L3: 5x5
4. L4: 6x6
5. L5: 7x7
6. L6: 8x8
7. L7: 9x9

레벨업 조건:
1. 체크포인트 PI >= 0.72
2. 그리고 최근 5초 히트 수 >= 레벨별 최소치
3. 조건 만족 시 L+1 (최대 L7)

레벨다운 완충:
1. PI < 0.40 상태가 2연속 체크포인트일 때만 L-1
2. 최소 L1 보장
3. 초반 이탈 방지를 위해 시작 10초는 레벨다운 금지

### 4.3 성과지수(PI) 계산식
체크포인트(최근 5초 윈도우) 기준:

`PI = 0.45 * accuracy + 0.35 * speed + 0.20 * combo`

정의:
1. `accuracy = hits / (hits + misses)` (0~1)
2. `speed = clamp(1 - avgReactionMs / 900, 0, 1)`
3. `combo = clamp(currentCombo / 20, 0, 1)`

설계 의도:
- 정확도를 가장 크게 반영
- 반응속도와 콤보를 보조 지표로 사용
- 단순 탭 난사 플레이를 불리하게 조정

### 4.4 스폰 규칙
- 동시 출현 수, 등장 간격, 유지 시간을 레벨별로 조정한다.

| 레벨 | 보드 | 동시 출현 수 | 스폰 간격(ms) | 유지 시간(ms) |
|---|---|---:|---:|---:|
| L1 | 3x3 | 1 | 900 | 1200 |
| L2 | 4x4 | 1~2 | 820 | 1080 |
| L3 | 5x5 | 1~2 | 760 | 980 |
| L4 | 6x6 | 2 | 700 | 900 |
| L5 | 7x7 | 2~3 | 640 | 820 |
| L6 | 8x8 | 2~3 | 580 | 760 |
| L7 | 9x9 | 3 | 520 | 700 |

추가 제약:
1. 동일 셀 재출현 쿨다운: 최소 900ms
2. 최근 타격 셀 주변(맨해튼 거리 1) 확률 가중치 하향
3. 플레이 20초 이후 특수 두더지 등장률 활성화

### 4.5 두더지 타입
| 타입 | 점수/효과 | 기본 등장률(L1~L3) | 후반 등장률(L4~L7) |
|---|---|---:|---:|
| 일반 | +1점 | 88% | 70% |
| 황금 | +3점 | 8% | 15% |
| 폭탄 | -3점 또는 -2초 | 4% | 12% |
| 얼음 | 맞히면 2초 슬로우 버프 | 0% | 3% |

## 5. 점수/경제 시스템

### 5.1 점수
- 기본 점수 = 타입 점수
- 콤보 멀티플라이어:
1. 0~4콤보: x1.0
2. 5~9콤보: x1.2
3. 10~14콤보: x1.5
4. 15+콤보: x2.0

### 5.2 코인 보상
경기 종료 코인:
- `floor(score / 10) + comboBonus + surviveBonus`

세부:
1. comboBonus = 최고콤보 10 이상일 때 +3
2. surviveBonus = 생존 45초 이상 +5, 60초 이상 +10
3. 광고 보상 버튼 클릭 시 +20 (일일 상한 권장)

## 6. 데이터 저장(프론트 전용)

### 6.1 저장소 전략
- 1차: `localStorage` 사용
- 2차 확장 시: `IndexedDB`로 이전(리플레이/세부 통계 저장 시)

### 6.2 저장 스키마(초안)
```json
{
  "version": 1,
  "profile": {
    "coins": 0,
    "bestScore": 0,
    "bestCombo": 0,
    "totalPlays": 0,
    "totalHits": 0,
    "totalMisses": 0
  },
  "settings": {
    "sound": true,
    "vibration": true
  },
  "unlock": {
    "skins": ["default"]
  },
  "localRanking": []
}
```

### 6.3 무결성
- 저장 시점: 게임 종료, 설정 변경, 스킨 구매 직후
- `version` 필드 기반 마이그레이션 함수 유지
- 점수 저장 시 최소 검증(음수 점수, NaN 차단)

## 7. 기술 아키텍처

### 7.1 렌더링
- 게임 필드: `Canvas`
- HUD/모달/광고 슬롯: `HTML + CSS`

### 7.2 모듈 구조
```txt
src/
  game/
    engine.ts
    spawn.ts
    difficulty.ts
    scoring.ts
    render.ts
    input.ts
  state/
    store.ts
    persistence.ts
  ui/
    screens/
      Title.tsx
      PlayHUD.tsx
      Result.tsx
    components/
      AdSlot.tsx
      RewardModal.tsx
  assets/
```

### 7.3 게임 루프 의사코드
```ts
while (isPlaying) {
  dt = now - prev;
  timer -= dt;
  spawnSystem.update(dt, level);
  moleSystem.update(dt);
  renderSystem.draw();

  if (checkpointEvery5s()) {
    pi = evaluatePerformance(last5sStats);
    level = updateLevel(level, pi);
    timer += computeTimeBonus(pi, last5sStats);
    timer = Math.min(timer, 120);
  }

  if (timer <= 0) endGame();
}
```

## 8. 성능/품질 기준
- 목표 FPS: 55~60 (중저가 모바일 기준)
- 입력 지연: `pointerdown` 기준 즉시 처리(300ms 클릭 지연 회피)
- 리사이즈 대응: 안전영역 내 보드 중앙 정렬 유지
- 메모리 안정화: 객체 풀링(이펙트 파티클), 이미지 사전 로드

## 9. 광고/수익화 적용 지점
- 타이틀: 배너
- 플레이: 배너(선택)
- 결과: 인터스티셜 트리거 최적 지점
- 보상 버튼: 광고 시청 후 코인/보너스 지급 UX

주의:
1. 플레이 도중 강제 전면 광고 금지
2. 광고 실패 시 대체 보상 정책(소량 코인) 정의
3. 프론트 단독 환경에서는 리워드 검증이 약하므로 서버 연동 여지 확보

## 10. 밸런싱 시작값(권장)
- 기본 시간: 30초
- 체크포인트 간격: 5초
- 최대 시간: 120초
- 레벨업 기준 PI: 0.72
- 시간 연장 기준 PI: 0.70 / 0.85
- 초기 보드: 3x3
- 최대 보드: 9x9

## 11. QA 체크리스트
1. 낮은 숙련 플레이 시 평균 종료 시간이 30~35초에 수렴하는가
2. 중간 숙련 플레이 시 45~70초 구간이 자연스럽게 형성되는가
3. 고숙련 플레이 시 9x9 도달 빈도가 적절한가(과도/과소 방지)
4. 레벨 업/다운이 급격하지 않고 예측 가능한가
5. 화면 회전/리사이즈 시 히트박스 오차가 없는가
6. 광고 로드 실패 시 결과 화면이 멈추지 않는가

## 12. 확장 계획
1. 시즌 미션/배틀패스(프론트 MVP 이후)
2. 서버 리더보드 및 치팅 방지 서명
3. 앱 래핑(하이브리드) 후 보상형 광고 네이티브 연동

